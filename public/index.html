<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>shibabox</title>
<style>
    :root { --bg: #121212; --accent: #1DB954; --text: #FFF; }
    /* ä¿®æ­£: heightã‚’100dvhã«ã—ã¦ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– */
    body { margin:0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 10000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; padding: 20px; box-sizing: border-box;
    }
    .overlay h2 { margin-bottom: 10px; font-size: 24px; color: var(--accent); }
    .overlay .room-id { font-size: 32px; font-weight: bold; margin-bottom: 20px; color: white; letter-spacing: 2px; word-break: break-all; }
    .overlay p { margin-bottom: 20px; color: #aaa; font-size: 14px; }
    
    .overlay input {
        width: 100%; max-width: 250px; padding: 15px; font-size: 16px;
        border: 2px solid var(--accent); border-radius: 30px;
        background: #222; color: white; text-align: center; margin-bottom: 20px; outline: none;
    }
    .overlay button {
        padding: 15px 50px; font-size: 18px; border-radius: 50px;
        background: var(--accent); border: none; font-weight: bold; cursor: pointer;
        color: white; box-shadow: 0 0 15px rgba(29, 185, 84, 0.4); margin-bottom: 15px;
    }
    
    .btn-share-sub {
        background: transparent !important; border: 1px solid #555 !important;
        box-shadow: none !important; color: #ccc !important; font-size: 14px !important;
        padding: 10px 20px !important; display: flex; align-items: center; gap: 5px;
    }

    header { 
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 15px; background: #121212; border-bottom: 1px solid #222;
        flex-shrink: 0; z-index: 500; position: relative; height: 50px; box-sizing: border-box;
    }
    .header-left { display: flex; align-items: center; overflow: hidden; white-space: nowrap; margin-right: 10px; }
    .header-logo { font-weight:bold; font-size:14px; color:#aaa; letter-spacing: 1px; flex-shrink: 0; }
    .header-room { color: var(--accent); margin-left: 5px; overflow: hidden; text-overflow: ellipsis; }
    .btn-share-header {
        background: #333; color: white; border: none; padding: 5px 12px;
        border-radius: 15px; font-size: 12px; cursor: pointer; 
        display: flex; align-items: center; gap: 4px; flex-shrink: 0; white-space: nowrap;
    }

    #player-area { width: 100%; background: #000; position: relative; padding-top: 56.25%; flex-shrink: 0; z-index: 10;}
    #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    .progress-container { padding: 10px 20px 0 20px; background: #181818; display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #555; border-radius: 2px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: var(--accent); margin-top: -4px; }
    .time-display { display: flex; justify-content: space-between; font-size: 11px; color: #b3b3b3; font-variant-numeric: tabular-nums; }

    .controls-main { display: flex; justify-content: space-between; align-items: center; padding: 5px 20px 15px 20px; background: #181818; border-bottom: 1px solid #333; flex-shrink: 0; }
    .ctrl-group { display: flex; align-items: center; gap: 20px; }
    .btn-ctrl { background: none; border: none; color: white; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .play-btn { background: white; color: black; font-size: 24px; width: 60px; height: 60px; border-radius: 50%; }
    .btn-mode { position: relative; font-size: 20px; color: #777; width: 40px; transition: all 0.2s; }
    .btn-mode.active-mode { color: var(--accent); text-shadow: 0 0 10px rgba(29, 185, 84, 0.4); }
    .btn-mode.active-mode::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background-color: var(--accent); border-radius: 50%; }

    /* ä¿®æ­£: position: relativeã‚’è¿½åŠ ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŸºæº–ã«ã™ã‚‹ */
    #list-area { flex: 1; overflow-y: auto; padding-bottom: 80px; position: relative; z-index: 5; }
    .song { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #282828; background: var(--bg); transition: background 0.2s; }
    .song.active { background: #1a1a1a; border-left: 4px solid var(--accent); }
    .song.active .title { color: var(--accent); font-weight: bold; }
    .thumb { width: 50px; height: 38px; object-fit: cover; margin-right: 12px; border-radius: 4px; flex-shrink: 0; }
    .info { flex: 1; overflow: hidden; cursor: pointer; padding: 5px 0; }
    .title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .artist { font-size: 11px; color: #b3b3b3; margin-top: 4px; display: flex; align-items: center; gap: 5px;}
    .user-badge { background: #333; padding: 2px 6px; border-radius: 4px; color: #aaa; font-size: 10px; flex-shrink: 0; }
    .actions { display: flex; gap: 8px; margin-left: 10px; flex-shrink: 0; }
    .btn-sm { background: #333; border: none; color: #ccc; width: 32px; height: 32px; border-radius: 4px; font-size: 14px; cursor: pointer; }
    .btn-del { color: #ff5555; background: #332222; }
    
    #add-bar { position: fixed; bottom: 0; width: 100%; background: #181818; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #333; z-index: 100; box-sizing: border-box; }
    #urlInput { flex: 1; background: #333; border: none; padding: 12px; border-radius: 20px; color: #fff; outline: none; min-width: 0; }
    .btn-add { background: var(--accent); border: none; padding: 0 20px; border-radius: 20px; font-weight: bold; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
    .btn-add:disabled { background: #555; cursor: wait; }

</style>
</head>
<body>

<div id="room-create-overlay" class="overlay" style="display:none;">
    <h2>shibabox</h2>
    <p>å¥½ããªéƒ¨å±‹ã®åå‰ã‚’æ±ºã‚ã¦ãã ã•ã„</p>
    <input type="text" id="room-name-input" placeholder="ä¾‹: drive, party">
    <button onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹</button>
</div>

<div id="join-overlay" class="overlay" style="display:none;">
    <h2>ROOM</h2>
    <div id="room-title-display" class="room-id">???</div>
    <button class="btn-share-sub" onclick="shareUrl()">ğŸ”— URLã‚’å‹é”ã«é€ã‚‹</button>
    <p style="margin-top:20px;">ã‚ãªãŸã®åå‰ã‚’æ•™ãˆã¦ãã ã•ã„</p>
    <input type="text" id="username-input" placeholder="ä¾‹: shibaton">
    <button onclick="joinRoom()">å‚åŠ ã™ã‚‹</button>
</div>

<header>
    <div class="header-left">
        <span class="header-logo">ğŸµ shibabox</span>
        <span id="header-room-name" class="header-room"></span>
    </div>
    <button class="btn-share-header" onclick="shareUrl()">ğŸ”— æ‹›å¾…</button>
</header>

<div id="player-area"><div id="player"></div></div>

<div class="progress-container">
    <input type="range" id="progressBar" value="0" min="0" max="100" step="1">
    <div class="time-display"><span id="currentTime">0:00</span><span id="duration">0:00</span></div>
</div>

<div class="controls-main">
    <button class="btn-ctrl btn-mode" id="btn-shuffle" onclick="toggleMode('shuffle')">ğŸ”€</button>
    <div class="ctrl-group">
        <button class="btn-ctrl" onclick="sendCtrl('prev')">â®</button>
        <button class="btn-ctrl play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
        <button class="btn-ctrl" onclick="sendCtrl('next')">â­</button>
    </div>
    <button class="btn-ctrl btn-mode" id="btn-loop" onclick="toggleMode('loop')">ğŸ”</button>
</div>

<div id="list-area"><div id="playlist"></div></div>

<div id="add-bar">
    <input type="text" id="urlInput" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘">
    <button class="btn-add" id="addBtn" onclick="add()">è¿½åŠ </button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let player, isReady = false;
    let myName = '';
    let currentRoomId = '';
    let isDragging = false;
    let lastState = { isPlaying: false, playlist: [] };

    window.onload = function() {
        let path = window.location.pathname;
        if (path.endsWith('/')) path = path.slice(0, -1);
        const roomId = path.substring(1);
        
        if (roomId) {
            currentRoomId = decodeURIComponent(roomId);
            document.getElementById('room-title-display').innerText = currentRoomId;
            document.getElementById('header-room-name').innerText = "/ " + currentRoomId;
            const storedName = localStorage.getItem('shiba_username');
            if(storedName) document.getElementById('username-input').value = storedName;
            document.getElementById('join-overlay').style.display = 'flex';
        } else {
            document.getElementById('room-create-overlay').style.display = 'flex';
        }
    };

    function createRoom() {
        const input = document.getElementById('room-name-input');
        const roomName = input.value.trim();
        if(roomName) window.location.href = '/' + encodeURIComponent(roomName);
        else alert('éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    async function shareUrl() {
        const url = window.location.href;
        const shareData = {
            title: 'shibabox',
            text: `shibaboxã®éƒ¨å±‹ã€Œ${currentRoomId}ã€ã«æ‹›å¾…ã•ã‚Œã¾ã—ãŸï¼`,
            url: url,
        };
        if (navigator.share) {
            try { await navigator.share(shareData); } catch (err) {}
        } else {
            try { await navigator.clipboard.writeText(url); alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n' + url); } 
            catch (err) { alert('URL: ' + url); }
        }
    }

    function joinRoom() {
        const input = document.getElementById('username-input');
        const name = input.value.trim();
        if(!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        myName = name;
        localStorage.setItem('shiba_username', name);
        document.getElementById('join-overlay').style.display = 'none';
        socket.emit('join_room', currentRoomId);
        if(player && isReady && lastState.isPlaying && lastState.playlist.length > 0) player.playVideo();
    }

    const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0, 'origin': window.location.origin },
            events: { 
                'onReady': () => { isReady=true; startProgressLoop(); }, 
                'onStateChange': e => { if(e.data===0) socket.emit('song_ended'); }
            }
        });
    }

    function startProgressLoop() {
        setInterval(() => {
            if (!isReady || !player || !player.getDuration) return;
            const duration = player.getDuration();
            const currentTime = player.getCurrentTime();
            if (!isDragging && duration > 0) {
                const range = document.getElementById('progressBar');
                range.max = duration;
                range.value = currentTime;
            }
            document.getElementById('currentTime').innerText = formatTime(currentTime);
            document.getElementById('duration').innerText = formatTime(duration);
        }, 500);
    }
    function formatTime(s) {
        if(!s) return "0:00";
        const m = Math.floor(s / 60);
        const sc = Math.floor(s % 60);
        return `${m}:${sc < 10 ? '0'+sc : sc}`;
    }
    const range = document.getElementById('progressBar');
    range.addEventListener('mousedown', () => isDragging = true);
    range.addEventListener('touchstart', () => isDragging = true);
    range.addEventListener('change', (e) => {
        isDragging = false;
        player.seekTo(e.target.value);
        socket.emit('seek', e.target.value);
    });

    async function add() {
        if(!myName) return;
        const input = document.getElementById('urlInput');
        const btn = document.getElementById('addBtn');
        const url = input.value;
        let vId = '';
        if(url.includes('v=')) vId = url.split('v=')[1].split('&')[0];
        else if(url.includes('youtu.be/')) vId = url.split('youtu.be/')[1].split('?')[0];

        if(vId) { 
            btn.disabled = true; btn.innerText = "...";
            try {
                const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${vId}`);
                const data = await res.json();
                socket.emit('add_song', { id: vId, title: data.title || `Track (${vId})`, user: myName });
                input.value = ''; input.blur();
            } catch (e) {
                socket.emit('add_song', { id: vId, title: `Track (${vId})`, user: myName });
            } finally {
                btn.disabled = false; btn.innerText = "è¿½åŠ ";
            }
        }
    }

    function sendCtrl(type) { socket.emit('control', { type }); }
    function togglePlay() {
        const btn = document.getElementById('playBtn');
        if(btn.innerText === 'â–¶') sendCtrl('play'); else sendCtrl('pause');
    }
    function toggleMode(mode) { socket.emit('toggle_mode', mode); }
    function editList(action, index) { socket.emit('edit_list', { action, index }); }
    function playSpecific(index) { socket.emit('play_specific', index); }

    socket.on('init_state', d => {
        lastState = d;
        renderList(d.playlist);
        highlight(d.currentSongIndex);
        updateModes(d.isLoop, d.isShuffle);
        if(document.getElementById('join-overlay').style.display === 'none') {
            if(d.playlist.length > 0) {
                 playVideo(d.playlist[d.currentSongIndex].id);
                 if(d.isPlaying) document.getElementById('playBtn').innerText = 'â¸';
            }
        }
    });
    socket.on('update_playlist', l => { lastState.playlist = l; renderList(l); });
    socket.on('update_index', i => highlight(i));
    socket.on('mode_update', d => updateModes(d.isLoop, d.isShuffle));
    socket.on('change_song', d => {
        playVideo(d.videoId); highlight(d.index);
        document.getElementById('playBtn').innerText = 'â¸';
    });
    socket.on('sync_action', d => {
        lastState.isPlaying = (d.type === 'play');
        if(!isReady) return;
        if(d.type === 'play') { player.playVideo(); document.getElementById('playBtn').innerText = 'â¸'; }
        if(d.type === 'pause') { player.pauseVideo(); document.getElementById('playBtn').innerText = 'â–¶'; }
        if(d.type === 'stop') { player.stopVideo(); document.getElementById('playBtn').innerText = 'â–¶'; }
    });
    socket.on('sync_seek', t => { if(isReady) player.seekTo(t); });

    function playVideo(id) { if(isReady) player.loadVideoById(id); }
    
    function updateModes(l, s) {
        const bl = document.getElementById('btn-loop');
        const bs = document.getElementById('btn-shuffle');
        if(l) bl.classList.add('active-mode'); else bl.classList.remove('active-mode');
        if(s) bs.classList.add('active-mode'); else bs.classList.remove('active-mode');
    }

    function renderList(list) {
        const div = document.getElementById('playlist');
        div.innerHTML = list.map((s, i) => `
            <div class="song" id="s-${i}">
                <img class="thumb" src="https://img.youtube.com/vi/${s.id}/mqdefault.jpg">
                <div class="info" onclick="playSpecific(${i})">
                    <div class="title">${s.title}</div>
                    <div class="artist"><span class="user-badge">${s.user || 'Guest'}</span></div>
                </div>
                <div class="actions">
                    <button class="btn-sm" onclick="editList('up', ${i})">â†‘</button>
                    <button class="btn-sm" onclick="editList('down', ${i})">â†“</button>
                    <button class="btn-sm btn-del" onclick="editList('delete', ${i})">Ã—</button>
                </div>
            </div>
        `).join('');
    }

    // â˜…ä¿®æ­£: ãƒªã‚¹ãƒˆå†…ã ã‘ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹å®‰å…¨ãªæ–¹æ³•ã«å¤‰æ›´
    function highlight(index) {
        document.querySelectorAll('.song').forEach(e => e.classList.remove('active'));
        const el = document.getElementById(`s-${index}`);
        if(el) { 
            el.classList.add('active'); 
            // ç”»é¢å…¨ä½“ã‚’å·»ãè¾¼ã¾ãªã„ã‚ˆã†ã«æ‰‹å‹•ã§ãƒªã‚¹ãƒˆå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨ˆç®—ã‚’ã™ã‚‹
            const container = document.getElementById('list-area');
            const elTop = el.offsetTop;
            const containerHeight = container.clientHeight;
            // çœŸã‚“ä¸­ã«æ¥ã‚‹ã‚ˆã†ã«è¨ˆç®—
            const targetScroll = elTop - (containerHeight / 2) + (el.clientHeight / 2);
            
            container.scrollTo({
                top: targetScroll,
                behavior: 'smooth'
            });
        }
    }
</script>
</body>
</html>
