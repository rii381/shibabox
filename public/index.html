<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>shibabox</title>
<style>
    :root { --bg: #121212; --accent: #1DB954; --text: #FFF; --gray: #282828; }
    body { margin:0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    /* åå‰å…¥åŠ›ç”»é¢ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
    #name-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #name-modal h2 { color: white; margin-bottom: 20px; font-size: 18px; }
    #name-modal input {
        width: 80%; max-width: 300px; padding: 15px; font-size: 16px;
        border: 2px solid var(--accent); border-radius: 30px;
        background: #333; color: white; text-align: center; margin-bottom: 20px; outline: none;
    }
    #name-modal button {
        padding: 12px 40px; font-size: 16px; border-radius: 30px;
        background: var(--accent); border: none; font-weight: bold; cursor: pointer;
    }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #player-area { width: 100%; background: #000; position: relative; padding-top: 56.25%; flex-shrink: 0; }
    #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    /* æ“ä½œãƒœã‚¿ãƒ³ */
    .controls-main { display: flex; justify-content: center; gap: 30px; align-items: center; padding: 15px; background: #181818; border-bottom: 1px solid #333; }
    .btn-ctrl { background: none; border: none; color: white; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-ctrl:active { opacity: 0.7; }
    .play-btn { background: white; color: black; font-size: 24px; width: 60px; height: 60px; border-radius: 50%; }

    /* ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ */
    #list-area { flex: 1; overflow-y: auto; padding-bottom: 80px; }
    
    .song { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #282828; background: var(--bg); transition: background 0.2s; }
    .song.active { background: #1a1a1a; border-left: 4px solid var(--accent); }
    .song.active .title { color: var(--accent); font-weight: bold; }
    
    .thumb { width: 50px; height: 38px; object-fit: cover; margin-right: 12px; border-radius: 4px; }
    
    /* æ›²æƒ…å ±ï¼ˆã“ã“ã‚’ã‚¿ãƒƒãƒ—ã§å†ç”Ÿï¼‰ */
    .info { flex: 1; overflow: hidden; cursor: pointer; padding: 5px 0; }
    .title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .artist { font-size: 11px; color: #b3b3b3; margin-top: 4px; display: flex; align-items: center; gap: 5px;}
    .user-badge { background: #333; padding: 2px 6px; border-radius: 4px; color: #aaa; font-size: 10px; }

    /* ç·¨é›†ãƒœã‚¿ãƒ³ */
    .actions { display: flex; gap: 8px; margin-left: 10px; }
    .btn-sm { background: #333; border: none; color: #ccc; width: 32px; height: 32px; border-radius: 4px; font-size: 14px; cursor: pointer; }
    .btn-del { color: #ff5555; background: #332222; }
    
    /* è¿½åŠ ãƒãƒ¼ */
    #add-bar { position: fixed; bottom: 0; width: 100%; background: #181818; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #333; z-index: 100; }
    #urlInput { flex: 1; background: #333; border: none; padding: 12px; border-radius: 20px; color: #fff; outline: none; }
    .btn-add { background: var(--accent); border: none; padding: 0 20px; border-radius: 20px; font-weight: bold; cursor: pointer; white-space: nowrap; }
    .btn-add:disabled { background: #555; cursor: wait; }

</style>
</head>
<body>

<div id="name-modal">
    <h2>åå‰ã‚’æ•™ãˆã¦ãã ã•ã„</h2>
    <input type="text" id="username-input" placeholder="ä¾‹: shibaton">
    <button onclick="saveName()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
</div>

<header style="text-align:center; padding:10px; font-weight:bold; font-size:12px; color:#666; letter-spacing: 1px;">ğŸµ shibabox</header>

<div id="player-area"><div id="player"></div></div>

<div class="controls-main">
    <button class="btn-ctrl" onclick="sendCtrl('prev')">â®</button>
    <button class="btn-ctrl play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
    <button class="btn-ctrl" onclick="sendCtrl('next')">â­</button>
</div>

<div id="list-area"><div id="playlist"></div></div>

<div id="add-bar">
    <input type="text" id="urlInput" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘">
    <button class="btn-add" id="addBtn" onclick="add()">è¿½åŠ </button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let player, isReady = false;
    let myName = '';

    // --- åå‰ä¿å­˜ã®å‡¦ç† ---
    const storedName = localStorage.getItem('shiba_username');
    if(storedName) {
        document.getElementById('username-input').value = storedName;
    }
    
    function saveName() {
        const input = document.getElementById('username-input');
        const name = input.value.trim();
        if(name) {
            myName = name;
            localStorage.setItem('shiba_username', name);
            document.getElementById('name-modal').style.display = 'none';
        } else {
            alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
        }
    }

    // YouTube API
    const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0 },
            events: { 
                'onReady': () => isReady=true, 
                'onStateChange': onStateChange 
            }
        });
    }

    function onStateChange(e) {
        if(e.data === 0) socket.emit('song_ended');
    }

    // --- æ›²è¿½åŠ ï¼ˆã“ã“ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã—ã¾ã™ï¼‰ ---
    async function add() {
        if(!myName) {
            alert("ã‚¨ãƒ©ãƒ¼: åå‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const input = document.getElementById('urlInput');
        const btn = document.getElementById('addBtn');
        const url = input.value;
        let vId = '';

        if(url.includes('v=')) vId = url.split('v=')[1].split('&')[0];
        else if(url.includes('youtu.be/')) vId = url.split('youtu.be/')[1].split('?')[0];

        if(vId) { 
            btn.disabled = true;
            btn.innerText = "å–å¾—ä¸­...";
            try {
                // æ›²åã‚’å–å¾—ã™ã‚‹APIã‚’ä½¿ç”¨
                const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${vId}`);
                const data = await response.json();
                
                // å–å¾—ã§ããŸã‚‰ãã®ã‚¿ã‚¤ãƒˆãƒ«ã€å¤±æ•—ã—ãŸã‚‰IDã‚’è¡¨ç¤º
                const title = data.title || `Track (${vId})`;
                
                // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ï¼ˆID, ã‚¿ã‚¤ãƒˆãƒ«, ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰
                socket.emit('add_song', { id: vId, title: title, user: myName });
                input.value = '';
                input.blur();
            } catch (e) {
                // é€šä¿¡ã‚¨ãƒ©ãƒ¼ãªã©ã®å ´åˆã‚‚æœ€ä½é™ã®ãƒ‡ãƒ¼ã‚¿ã§è¿½åŠ 
                socket.emit('add_song', { id: vId, title: `Track (${vId})`, user: myName });
            } finally {
                btn.disabled = false;
                btn.innerText = "è¿½åŠ ";
            }
        }
    }

    function sendCtrl(type) { socket.emit('control', { type }); }
    
    function togglePlay() {
        const btn = document.getElementById('playBtn');
        if(btn.innerText === 'â–¶') sendCtrl('play');
        else sendCtrl('pause');
    }

    function editList(action, index) {
        socket.emit('edit_list', { action, index });
    }

    // ã‚¿ãƒƒãƒ—ã—ã¦å†ç”Ÿ
    function playSpecific(index) {
        socket.emit('play_specific', index);
    }

    // --- ç”»é¢æ›´æ–° ---
    socket.on('init_state', d => {
        renderList(d.playlist);
        highlight(d.currentSongIndex);
        if(d.playlist.length > 0) {
             playVideo(d.playlist[d.currentSongIndex].id);
             if(d.isPlaying) document.getElementById('playBtn').innerText = 'â¸';
        }
    });

    socket.on('update_playlist', list => renderList(list));
    socket.on('update_index', idx => highlight(idx));

    socket.on('change_song', d => {
        playVideo(d.videoId);
        highlight(d.index);
        document.getElementById('playBtn').innerText = 'â¸';
    });

    socket.on('sync_action', d => {
        if(!isReady) return;
        if(d.type === 'play') { player.playVideo(); document.getElementById('playBtn').innerText = 'â¸'; }
        if(d.type === 'pause') { player.pauseVideo(); document.getElementById('playBtn').innerText = 'â–¶'; }
        if(d.type === 'stop') { player.stopVideo(); document.getElementById('playBtn').innerText = 'â–¶'; }
    });

    function playVideo(id) {
        if(isReady) player.loadVideoById(id);
    }

    function renderList(list) {
        const div = document.getElementById('playlist');
        // ã“ã“ã§ãƒªã‚¹ãƒˆã®ä¸­èº«ï¼ˆHTMLï¼‰ã‚’ä½œã£ã¦ã„ã¾ã™
        div.innerHTML = list.map((s, i) => `
            <div class="song" id="s-${i}">
                <img class="thumb" src="https://img.youtube.com/vi/${s.id}/mqdefault.jpg">
                <div class="info" onclick="playSpecific(${i})">
                    <div class="title">${s.title}</div>
                    <div class="artist">
                        <span class="user-badge">${s.user || 'Guest'}</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn-sm" onclick="editList('up', ${i})">â†‘</button>
                    <button class="btn-sm" onclick="editList('down', ${i})">â†“</button>
                    <button class="btn-sm btn-del" onclick="editList('delete', ${i})">Ã—</button>
                </div>
            </div>
        `).join('');
    }

    function highlight(index) {
        document.querySelectorAll('.song').forEach(e => e.classList.remove('active'));
        const el = document.getElementById(`s-${index}`);
        if(el) { 
            el.classList.add('active'); 
            el.scrollIntoView({ behavior:'smooth', block:'center' });
        }
    }
</script>
</body>
</html>
